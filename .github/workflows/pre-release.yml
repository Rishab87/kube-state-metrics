name: Pre-Release

on:
  workflow_dispatch:
    inputs:
      new_version:
        description: 'The new release version (e.g., v2.10.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  
env:
  GO_VERSION: "^1.24.6"
  GOLANGCI_LINT_VERSION: "v2.4.0"
  E2E_SETUP_KIND: yes
  E2E_SETUP_KUBECTL: yes

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: 'Validate version format'
        run: |
          if [[ ! "${{ inputs.new_version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version format is incorrect. It must be in the format 'vX.Y.Z'."
            exit 1
          fi
          echo "Version format is valid."
      - name: Checkout into the corresponding release branch
        uses: actions/checkout@v4
      - name: Create VCS sandbox
        run: |
          git checkout -b release-prep-${{ inputs.new_version }}
          MAJOR_MINOR_VERSION=$(echo "${{ inputs.new_version }}" | sed 's/^v//' | cut -d. -f1,2)
          if git show-ref --verify --quiet refs/remotes/origin/release-$MAJOR_MINOR_VERSION; then
            echo "Release branch release-$MAJOR_MINOR_VERSION already exists, switching to it"
            git checkout -b release-$MAJOR_MINOR_VERSION origin/release-$MAJOR_MINOR_VERSION
          else
            echo "Creating new release branch release-$MAJOR_MINOR_VERSION"
            git checkout -b release-$MAJOR_MINOR_VERSION
            git push origin release-$MAJOR_MINOR_VERSION
          fi          
          git checkout release-prep-${{ inputs.new_version }}
      - name: Set up the Go@${{ env.GO_VERSION }} environment
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Update the VERSION manifest
        run: echo "${{ inputs.new_version }}" | sed 's/^v//' > VERSION
      - name: update data.yaml
        run: |
            chmod +x scripts/update-data-yaml.sh
            ./scripts/update-data-yaml.sh "${{ inputs.new_version }}"
      - name: Update the compatibility matrix (README.md)
        run: make generate
      - name: Generate the release date for unreleased (CHANGELOG.md)
        run: |
          chmod +x scripts/generate-release-date.sh
          ./scripts/generate-release-date.sh "${{ inputs.new_version }}"
      - name: Generate manifests
        run: make examples
      # - name: Lint
      #   run: |
      #     curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | \
      #     sh -s -- -b $(go env GOPATH)/bin ${{ env.GOLANGCI_LINT_VERSION }}
      #     make lint-fix
      # - name: Run rule tests
      #   run: PROMTOOL_CLI=./promtool make install-promtool test-rules
      # - name: Run unit tests
      #   run: make test-unit
      - name: Run end-to-end tests
        run: |
          make e2e
          find examples -name "*.yaml" -type f -exec sed -i 's|kube-state-metrics-amd64|kube-state-metrics|g; s|kube-state-metrics-arm64|kube-state-metrics|g' {} \;
      - name: Update the remote and commit the changes
        run: |
          git config --local user.email "ksm-release-bot@mock-k8s.io"
          git config --local user.name "KSM Release Bot"
          git add .
          git commit -m "chore: Cut ${{ inputs.new_version }}"
          MAJOR_MINOR_VERSION=$(echo "${{ inputs.new_version }}" | sed 's/^v//' | cut -d. -f1,2)
          git push origin release-prep-${{ inputs.new_version }}
      # - name: 'Run benchmark tests'
      #   run: |
      #     BENCHSTAT_OUTPUT_FILE=result.txt ./tests/compare_benchmarks.sh main 2
      # - name: Post results to job summary
      #   run: |
      #     echo "### Benchmark Comparison Results" >> "$GITHUB_STEP_SUMMARY"
      #     echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
      #     cat result.txt >> "$GITHUB_STEP_SUMMARY"
      #     echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
      # - name: Validate docs
      #   run: make doccheck
      # - name: Validate manifests
      #   run: make validate-manifests
      # - name: Validate go modules
      #   run: make validate-modules
      - name: Create a pull request
        run: |
          MAJOR_MINOR_VERSION=$(echo "${{ inputs.new_version }}" | sed 's/^v//' | cut -d. -f1,2)
          
          PREV_TAG=$(git tag --sort=-version:refname | head -n1 || echo "")
          
          if [[ -n "$PREV_TAG" ]]; then
            PREV_TAG_DATE="$(git show -s --format=%cI "$PREV_TAG" 2>/dev/null || true)"
            RANGE="${PREV_TAG}..HEAD"
          else
            PREV_TAG_DATE="1970-01-01T00:00:00Z"
            PREV_REF="$(git rev-list --max-parents=0 HEAD)"
            RANGE="${PREV_REF}..HEAD"
          fi
          
          PREV_DATE_SHORT="$(date -d "$PREV_TAG_DATE" +%Y-%m-%d 2>/dev/null || echo "1970-01-01")"
          TAG_DATE_SHORT="$(date -u +%Y-%m-%d)"
          
          CHANGELOG_SECTION=$(awk '/^## '"${{ inputs.new_version }}"'/{flag=1; next} /^## /{if(flag) exit} flag' CHANGELOG.md | grep -E '^\s*\*\s*\[' | sed 's/^/    /' || echo "    No user-facing changes found for this version.")
          
          PR_LINES="$(gh pr list --state merged --search "merged:${PREV_DATE_SHORT}..${TAG_DATE_SHORT}" --json number,title,author --limit 1000 --template '{{range .}}{{.number}}|{{.title}}|{{.author.login}}{{"\n"}}{{end}}')" || true
          
          FULL_CHANGELOG_LINES=()
          if [[ -n "$PR_LINES" ]]; then
            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                prnum="${line%%|*}"
                rest="${line#*|}"
                title="${rest%%|*}"
                login="${rest##*|}"
                FULL_CHANGELOG_LINES+=("    - ${title} by @${login} in #${prnum}")
              fi
            done <<< "$PR_LINES"
          fi
          
          FULL_CHANGELOG_TEXT=""
          if [[ ${#FULL_CHANGELOG_LINES[@]} -gt 0 ]]; then
            printf -v FULL_CHANGELOG_TEXT "%s\n" "${FULL_CHANGELOG_LINES[@]}"
          else
            FULL_CHANGELOG_TEXT="    (no merged PRs found in this release)"
          fi
          
          # Create PR body file to avoid quote issues
          cat > pr_body.txt << EOF
          This PR was automatically created by the release workflow.

          ## Changelog

          $CHANGELOG_SECTION

          ## Full Changelog

          $FULL_CHANGELOG_TEXT
          EOF

          gh pr create \
            --title "chore: Cut ${{ inputs.new_version }}" \
            --body-file pr_body.txt \
            --base release-$MAJOR_MINOR_VERSION \
            --head release-prep-${{ inputs.new_version }}           
          rm pr_body.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
